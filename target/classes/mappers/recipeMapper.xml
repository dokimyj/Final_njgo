<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="recipeMapper">
	<!-- view -->
	<select id="rview" parameterType="java.lang.Integer" resultType="com.njgo.dto.RecipeDTO">
		select * from RECIPE where NUM=#{num}
	</select>
	<select id="iview" parameterType="java.lang.Integer" resultType="com.njgo.dto.IngredientsDTO">
		select NAME, AMOUNT from INGREDIENTS where RECIPENUM=#{num}
	</select>
	<select id="sview" parameterType="java.lang.Integer" resultType="com.njgo.dto.StepsDTO">
		select STEP, EXPLAIN, FNAME, ONAME from STEPS where RECIPENUM=#{num}
	</select>
	<select id="tview" parameterType="java.lang.Integer" resultType="com.njgo.dto.HashtagDTO">
		select HASHTAG from HASHTAG where RECIPENUM=#{num}
	</select>
	
	<!-- list -->
	<select id="count" parameterType="com.njgo.util.ListInfo" resultType="java.lang.Integer">
		select COUNT(NUM) from RECIPE
		<if test="search=='title'">
			where TITLE like '%'||#{find}||'%'
		</if>
		<if test="search=='writer'">
			where WRITER like '%'||#{find}||'%'
		</if>
	</select>
	<select id="list" parameterType="com.njgo.util.ListInfo" resultType="com.njgo.dto.RecipeDTO">
		select * from 
		(select ROWNUM R, L.* from 
		(select NUM, WRITER, FOODNAME, TITLE, REP_PIC, RATING, ELAPSEDTIME, SCRAP from RECIPE 
			<if test="search=='title'">
				where TITLE like '%'||#{find}||'%'
			</if>
			<if test="search=='writer'">
				where WRITER like '%'||#{find}||'%'
			</if>
		  order by
		<if test="order=='regdate'">
			REGDATE
		</if>
		<if test="order=='rating'">
			RATING
		</if>
		<if test="order=='hit'">
			HIT
		</if>
		  desc) L) 
		where R between #{startRow} and #{lastRow}		
	</select>
	<select id="search" parameterType="com.njgo.util.ListInfo" resultType="com.njgo.dto.RecipeDTO">
		select * from 
		(select ROWNUM R, L.* from 
		(select C.NUM, C.WRITER, C.FOODNAME, C.TITLE, C.REP_PIC, C.RATING, C.ELAPSEDTIME, C.SCRAP from RECIPE C, INGREDIENTS I
		 where C.NUM=I.RECIPENUM and C.FOODNAME like '%'||#{find}||'%' or C.NUM=(select RECIPENUM from INGREDIENTS where NAME like '%'||#{find}||'%')
		 order by
		<if test="order=='regdate'">
			REGDATE
		</if>
		<if test="order=='rating'">
			RATING
		</if>
		<if test="order=='hit'">
			HIT
		</if>
		  desc) L) 
		where R between #{startRow} and #{lastRow}
	</select>
	<select id="catesearch" parameterType="java.util.HashMap" resultType="com.njgo.dto.RecipeDTO">
		select * from 
		(select ROWNUM R, L.* from 
		(select C.NUM, C.WRITER, C.FOODNAME, C.TITLE, C.REP_PIC, C.RATING, C.ELAPSEDTIME, C.SCRAP from RECIPE C, CATEGORY T
		 where C.NUM=T.RECIPENUM and T.RECIPENUM=(select RECIPENUM from CATEGORY where C_KIND=#{category.c_kind} and C_SITUATION=#{category.c_situation} and C_PROCEDURE=#{category.c_procedure} and C_INGREDIENT=#{category.c_ingredients})
		 order by
		<if test="order=='regdate'">
			C.REGDATE
		</if>
		<if test="order=='rating'">
			C.RATING
		</if>
		 desc) L) 
		where R between #{listInfo.startRow} and #{listInfo.lastRow}
	</select>	
	<select id="isearch" parameterType="java.util.HashMap" resultType="com.njgo.dto.RecipeDTO">
		select * from 
		(select ROWNUM R, L.* from 
		(select C.NUM, C.WRITER, C.FOODNAME, C.TITLE, C.REP_PIC, C.RATING, C.ELAPSEDTIME, C.SCRAP from RECIPE C, INGREDIENTS I
		 where C.NUM=I.RECIPENUM and I.RECIPENUM=(select RECIPENUM from INGREDIENTS where NAME in 
			<foreach collection="ingredients" item="dto" open="(" separator="," close=")">
				#{dto.name}
			</foreach>)
		 order by
		<if test="order=='regdate'">
			C.REGDATE
		</if>
		<if test="order=='rating'">
			C.RATING
		</if>
		 desc) L) 
		where R between #{listInfo.startRow} and #{listInfo.lastRow}
	</select> 
	
	
	<!-- scrap -->
	<update id="scrapI" parameterType="java.lang.Integer">
		update RECIPE set SCRAP=SCRAP+1
	</update>
	<update id="scrapD" parameterType="java.lang.Integer">
		update RECIPE set SCRAP=SCRAP-1
	</update>
</mapper>